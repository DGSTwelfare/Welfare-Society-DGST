<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DGST Office Welfare Society - v4.0 (Firebase Cloud)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .retired-row { background-color: #fff3cd !important; border-left: 4px solid #f39c12; }
        .retiring-soon-row { background-color: #ffeaa7 !important; border-left: 4px solid #e67e22; }
        .paid-row { background-color: #d5f4e6 !important; border-left: 4px solid #2ecc71; }
        .pending-row { background-color: #fadbd8 !important; border-left: 4px solid #e74c3c; }
        .advance-row { background-color: #d6eaf8 !important; border-left: 4px solid #3498db; }
        .deleted-row { background-color: #f5f5f5 !important; border-left: 4px solid #95a5a6; text-decoration: line-through; opacity: 0.7; }
        .parked-row { background-color: #e0e0e0 !important; border-left: 4px solid #9e9e9e; opacity: 0.8; }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-active { background: #d4edda; color: #155724; }
        .status-retired { background: #f8d7da; color: #721c24; }
        .status-retiring { background: #fff3cd; color: #856404; }
        .status-pending { background: #f8d7da; color: #721c24; }
        .status-paid { background: #d4edda; color: #155724; }
        .status-advance { background: #cce5ff; color: #004085; }
        .status-deleted { background: #e0e0e0; color: #666; }
        .status-parked { background: #e2e3e5; color: #383d41; }
        
        /* Hover Effects */
        .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .print-table { border-collapse: collapse; width: 100%; font-size: 12px; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 6px; }
            .print-table th { background-color: #f0f0f0 !important; color: #000 !important; }
            .receipt-print { border: 2px solid #000 !important; padding: 20px !important; margin: 20px !important; }
        }
        
        /* Payment Button Animation */
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        /* Tab Styles */
        .tab-btn { border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab-btn.active { border-bottom-color: #3b82f6; color: #3b82f6; }
        
        /* Animation for save */
        @keyframes highlightSave {
            0% { background-color: rgba(34, 197, 94, 0.3); }
            100% { background-color: transparent; }
        }
        .save-highlight { animation: highlightSave 1s ease-in-out; }
        
        /* Undo Toast */
        .undo-toast { animation: slideInRight 0.3s ease-out; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        /* Read-only styles */
        .read-only { pointer-events: none; opacity: 0.7; }
        .read-only input, .read-only select, .read-only textarea, .read-only button { pointer-events: none; opacity: 0.6; }
        
        .admin-only { /* Admin-only elements will be hidden for viewers */ }
        .viewer-hide { /* Elements to hide from viewers */ }
        
        .role-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .role-admin { background: #3b82f6; color: white; }
        .role-viewer { background: #10b981; color: white; }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Cloud Sync Indicator */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Online/Offline Indicator */
        .online-status {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            z-index: 1000;
        }
        .online-status.online { background: #10b981; box-shadow: 0 0 10px #10b981; }
        .online-status.offline { background: #ef4444; box-shadow: 0 0 10px #ef4444; }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Online/Offline Indicator -->
    <div id="onlineStatus" class="online-status offline"></div>
    
    <!-- Sync Indicator -->
    <div id="syncIndicator" class="sync-indicator hidden">
        <i class="fas fa-sync fa-spin"></i>
        <span id="syncText">Syncing...</span>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <h2 class="text-xl font-bold text-gray-800">DGST Welfare Society</h2>
            <p class="text-gray-600">Loading Cloud System...</p>
            <p id="loadingMessage" class="text-sm text-gray-500 mt-2">Connecting to Firebase</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden fixed inset-0 bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center z-40">
        <div class="glass-card rounded-2xl p-8 w-96 max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-orange-500 to-red-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <i class="fas fa-cloud text-white text-3xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-gray-800">DGST Welfare Society</h2>
                <p class="text-gray-600 mt-2">Cloud System v4.0</p>
                <div class="mt-4 text-sm text-gray-500">
                    <p><i class="fas fa-cloud-upload-alt mr-2"></i> Real-time Cloud Sync</p>
                    <p><i class="fas fa-users mr-2"></i> Multi-Device Access</p>
                    <p><i class="fas fa-shield-alt mr-2"></i> Secure Firebase Authentication</p>
                </div>
            </div>
            
            <div id="emailLoginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-envelope mr-2"></i>Email Address
                    </label>
                    <input 
                        type="email" 
                        id="emailInput" 
                        placeholder="admin@dgst.com"
                        class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none pl-12"
                        autocomplete="email"
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-key mr-2"></i>Password
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="passwordInput" 
                            placeholder="Enter your password"
                            class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none pl-12"
                            autocomplete="current-password"
                        />
                        <i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <button 
                            id="togglePassword"
                            type="button"
                            class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-500"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="errorText">Invalid email or password</span>
                </div>
                
                <button 
                    id="loginBtn"
                    class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-4 rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all transform hover:scale-105 shadow-lg flex items-center justify-center gap-3"
                >
                    <i class="fas fa-sign-in-alt"></i>
                    Login to Cloud Dashboard
                </button>
                
                <div class="text-center">
                    <button 
                        id="setupFirstTimeBtn"
                        class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                    >
                        <i class="fas fa-user-plus mr-1"></i>First Time Setup
                    </button>
                </div>
            </div>
            
            <!-- First Time Setup Form -->
            <div id="firstTimeSetupForm" class="hidden space-y-6">
                <div class="text-center">
                    <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                        <i class="fas fa-user-shield text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">First Time Setup</h3>
                    <p class="text-gray-600 text-sm">Create Admin Account for DGST Welfare Society</p>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Admin Email</label>
                    <input 
                        type="email" 
                        id="setupEmail" 
                        placeholder="admin@dgst.com"
                        class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none"
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Admin Password (min 6 characters)</label>
                    <input 
                        type="password" 
                        id="setupPassword" 
                        placeholder="Create secure password"
                        class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none"
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Confirm Password</label>
                    <input 
                        type="password" 
                        id="setupConfirmPassword" 
                        placeholder="Confirm password"
                        class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none"
                    />
                </div>
                
                <div id="setupError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="setupErrorText">Passwords don't match</span>
                </div>
                
                <div class="flex gap-4">
                    <button 
                        id="setupBtn"
                        class="flex-1 bg-gradient-to-r from-green-600 to-emerald-700 text-white py-3 rounded-xl font-semibold hover:from-green-700 hover:to-emerald-800"
                    >
                        <i class="fas fa-save mr-2"></i>Setup System
                    </button>
                    <button 
                        id="backToLoginBtn"
                        class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400"
                    >
                        <i class="fas fa-arrow-left mr-2"></i>Back
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-700 to-purple-800 text-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                            <i class="fas fa-cloud text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">DGST Welfare Society</h1>
                            <p class="text-blue-200 text-sm">Cloud System v4.0 | 
                                <span id="userRoleBadge" class="ml-2 px-2 py-1 rounded text-xs"></span>
                                <span id="userEmail" class="ml-2 text-xs opacity-75"></span>
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="hidden md:block text-right">
                            <p class="text-sm text-blue-200" id="currentDateTime"></p>
                            <p class="text-sm font-semibold" id="userRole">Cloud System</p>
                        </div>
                        
                        <!-- Settings Dropdown Menu -->
                        <div class="relative">
                            <button 
                                id="userMenuBtn"
                                class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2"
                            >
                                <i class="fas fa-user-circle"></i>
                                <span id="userRoleText">User</span>
                                <i class="fas fa-chevron-down ml-2 text-sm"></i>
                            </button>
                            
                            <!-- Dropdown Menu -->
                            <div id="userDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg z-50 border border-gray-200">
                                <div class="p-4 border-b">
                                    <p class="font-semibold text-gray-800" id="dropdownUserName">System User</p>
                                    <p class="text-sm text-gray-600" id="dropdownUserRole">DGST Welfare Society</p>
                                </div>
                                <div class="py-2">
                                    <button 
                                        id="changePasswordBtn"
                                        class="w-full text-left px-4 py-3 hover:bg-blue-50 text-gray-700 flex items-center gap-2"
                                    >
                                        <i class="fas fa-key text-blue-600"></i>
                                        Change Password
                                    </button>
                                    <button 
                                        id="manageUsersBtn"
                                        class="w-full text-left px-4 py-3 hover:bg-blue-50 text-gray-700 flex items-center gap-2 admin-only"
                                    >
                                        <i class="fas fa-users-cog text-green-600"></i>
                                        Manage Users
                                    </button>
                                    <button 
                                        id="cloudBackupBtn"
                                        class="w-full text-left px-4 py-3 hover:bg-blue-50 text-gray-700 flex items-center gap-2"
                                    >
                                        <i class="fas fa-cloud-download-alt text-purple-600"></i>
                                        Cloud Backup
                                    </button>
                                    <div class="border-t my-2"></div>
                                    <button 
                                        onclick="logout()"
                                        class="w-full text-left px-4 py-3 hover:bg-red-50 text-red-600 flex items-center gap-2"
                                    >
                                        <i class="fas fa-sign-out-alt"></i>
                                        Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Current Month Info -->
            <div class="glass-card rounded-2xl p-6 mb-8 bg-gradient-to-r from-blue-50 to-cyan-50 border-2 border-blue-200">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-cloud mr-3 text-blue-600"></i>
                            <span id="currentMonthYear">December 2025</span>
                        </h2>
                        <p class="text-gray-600 mt-1">Cloud System Active - <span id="accessMode">Real-time Sync</span></p>
                        <p class="text-xs text-blue-500 mt-1" id="syncStatus">
                            <i class="fas fa-wifi"></i> <span id="connectionStatus">Connecting...</span>
                        </p>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <!-- Current Month Receivable -->
                        <div class="text-center">
                            <div class="text-lg font-bold text-blue-700" id="currentMonthReceivable">â‚¹0</div>
                            <div class="text-sm text-blue-600">Current Month Receivable</div>
                        </div>
                        
                        <!-- Current Month Received -->
                        <div class="text-center">
                            <div class="text-lg font-bold text-green-700" id="currentMonthReceived">â‚¹0</div>
                            <div class="text-sm text-green-600">Current Month Received</div>
                        </div>
                        
                        <!-- Current Month Withdrawn -->
                        <div class="text-center">
                            <div class="text-lg font-bold text-red-700" id="currentMonthWithdrawn">â‚¹0</div>
                            <div class="text-sm text-red-600">Current Month Withdrawn</div>
                        </div>
                        
                        <!-- Current Balance -->
                        <div class="text-center">
                            <div class="text-lg font-bold text-purple-700" id="currentBalance">â‚¹0</div>
                            <div class="text-sm text-purple-600">Cloud Balance</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Members -->
                <div class="glass-card rounded-2xl p-6 hover-lift">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold">Total Members</p>
                            <p class="text-3xl font-bold text-gray-800 mt-2" id="totalMembers">120</p>
                        </div>
                        <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-users text-blue-600 text-2xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button 
                            onclick="showAllMembersView()"
                            class="text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center gap-2"
                        >
                            View All Members <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Current Month Receivable -->
                <div class="glass-card rounded-2xl p-6 hover-lift">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold">Current Month Receivable</p>
                            <p class="text-3xl font-bold text-blue-700 mt-2" id="totalReceivable">â‚¹12,000</p>
                        </div>
                        <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-money-bill-wave text-blue-600 text-2xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 text-sm text-gray-500">
                        <p>Monthly â‚¹100 per member</p>
                    </div>
                </div>

                <!-- Current Month Received -->
                <div class="glass-card rounded-2xl p-6 hover-lift">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold">Current Month Received</p>
                            <p class="text-3xl font-bold text-purple-700 mt-2" id="totalReceived">â‚¹0</p>
                        </div>
                        <div class="w-14 h-14 bg-purple-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-hand-holding-usd text-purple-600 text-2xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="collectionProgress" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Pending Members -->
                <div class="glass-card rounded-2xl p-6 hover-lift">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold">Pending Payments</p>
                            <p class="text-3xl font-bold text-red-700 mt-2" id="pendingMembers">120</p>
                        </div>
                        <div class="w-14 h-14 bg-red-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-clock text-red-600 text-2xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button 
                            onclick="showQuickPaymentModal()"
                            class="text-red-600 hover:text-red-800 text-sm font-semibold flex items-center gap-2 admin-only"
                        >
                            <i class="fas fa-plus-circle"></i> Quick Add Payment
                        </button>
                        <button 
                            onclick="showPendingPayments()"
                            class="text-red-600 hover:text-red-800 text-sm font-semibold flex items-center gap-2"
                        >
                            <i class="fas fa-list"></i> View Pending
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Add Payment (Admin Only) -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer pulse bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 admin-only" onclick="showQuickPaymentModal()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-money-bill-wave text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Add Payment</h3>
                            <p class="text-sm text-gray-600">Record member payment</p>
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-green-600 font-semibold">
                        <i class="fas fa-bolt mr-1"></i> Admin Only
                    </div>
                </div>

                <!-- Add Member (Admin Only) -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer admin-only" onclick="showAddMemberModal()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-cyan-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-user-plus text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Add New Member</h3>
                            <p class="text-sm text-gray-600">Register new society member</p>
                        </div>
                    </div>
                </div>

                <!-- All Members (All Users) -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showAllMembersView()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-users text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">All Members</h3>
                            <p class="text-sm text-gray-600">View complete member list</p>
                        </div>
                    </div>
                </div>

                <!-- Monthly Report (All Users) -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showMonthlyReport()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-teal-500 to-cyan-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-calendar-alt text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Monthly Report</h3>
                            <p class="text-sm text-gray-600">View month-wise collections</p>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp (Admin Only) -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer admin-only" onclick="showMessagingPanel()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-green-600 to-teal-600 rounded-xl flex items-center justify-center">
                            <i class="fab fa-whatsapp text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">WhatsApp Messaging</h3>
                            <p class="text-sm text-gray-600">Send bulk messages/reminders</p>
                        </div>
                    </div>
                </div>
                
                <!-- Edit Members (Admin Only) -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer admin-only" onclick="showAllMembersEdit()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-user-edit text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Edit Members</h3>
                            <p class="text-sm text-gray-600">Edit member details and payments</p>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Reports (All Users) -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showPaymentReports()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-orange-500 to-red-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-invoice-dollar text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Payment Reports</h3>
                            <p class="text-sm text-gray-600">View all payment history</p>
                        </div>
                    </div>
                </div>
                
                <!-- Pending Members (All Users) -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showPendingPayments()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-red-500 to-pink-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Pending Payments</h3>
                            <p class="text-sm text-gray-600">View pending dues list</p>
                        </div>
                    </div>
                </div>

                <!-- Excel Data Export Button (All Users) -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showExcelExportOptions()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-teal-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-excel text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Excel Data Export</h3>
                            <p class="text-sm text-gray-600">Export all data to Excel</p>
                        </div>
                    </div>
                </div>

                <!-- Parked Members View (All Users) -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showParkedMembers()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-gray-500 to-gray-700 rounded-xl flex items-center justify-center">
                            <i class="fas fa-parking text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Parked Members</h3>
                            <p class="text-sm text-gray-600">Non-contributing members</p>
                        </div>
                    </div>
                </div>

                <!-- Retired Members Details (All Users) -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showRetiredMembersDetails()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-orange-500 to-amber-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-user-clock text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Retired Members</h3>
                            <p class="text-sm text-gray-600">Detailed retired members list</p>
                        </div>
                    </div>
                </div>

                <!-- JSON Export Button (All Users) -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="exportDataForEmail()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-teal-500 to-green-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-export text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Cloud Backup</h3>
                            <p class="text-sm text-gray-600">Download JSON file</p>
                        </div>
                    </div>
                </div>

                <!-- Main Account Withdrawal Button (Admin Only) -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer admin-only" onclick="showMainAccountWithdrawalModal()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-amber-500 to-orange-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-university text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Main Account Withdrawal</h3>
                            <p class="text-sm text-gray-600">Society account à¤¸à¥‡ à¤¨à¤¿à¤•à¤¾à¤¸à¥€</p>
                        </div>
                    </div>
                </div>

                <!-- Withdrawal Reports (All Users) -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showWithdrawalReports()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-pink-500 to-rose-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-invoice text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Withdrawal Reports</h3>
                            <p class="text-sm text-gray-600">View all withdrawals</p>
                        </div>
                    </div>
                </div>

                <!-- Cloud Users Management (Admin Only) -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer admin-only" onclick="showUsersManagement()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-users-cog text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">User Management</h3>
                            <p class="text-sm text-gray-600">Manage cloud users</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Payments -->
            <div class="glass-card rounded-2xl p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-800 text-xl">
                        <i class="fas fa-history mr-3"></i>Recent Payments
                    </h3>
                    <button 
                        onclick="showPaymentReports()"
                        class="text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center gap-2"
                    >
                        View All <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                
                <div class="space-y-3 max-h-60 overflow-y-auto" id="recentPayments">
                    <div class="text-center py-4 text-gray-400">
                        <i class="fas fa-circle-notch fa-spin text-xl"></i>
                        <p class="mt-2">Loading payment history...</p>
                    </div>
                </div>
            </div>

            <!-- Recent Withdrawals -->
            <div class="glass-card rounded-2xl p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-800 text-xl">
                        <i class="fas fa-money-check-alt mr-3"></i>Recent Withdrawals
                    </h3>
                    <button 
                        onclick="showWithdrawalReports()"
                        class="text-red-600 hover:text-red-800 text-sm font-semibold flex items-center gap-2"
                    >
                        View All <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                
                <div class="space-y-3 max-h-60 overflow-y-auto" id="recentWithdrawals">
                    <div class="text-center py-4 text-gray-400">
                        <i class="fas fa-circle-notch fa-spin text-xl"></i>
                        <p class="mt-2">Loading withdrawal history...</p>
                    </div>
                </div>
            </div>

            <!-- Cloud Activity Log -->
            <div class="glass-card rounded-2xl p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-800 text-xl">
                        <i class="fas fa-cloud-upload-alt mr-3"></i>Cloud Activity Log
                    </h3>
                    <span class="text-xs text-gray-500" id="lastSyncTime">Last sync: --</span>
                </div>
                
                <div class="space-y-3 max-h-60 overflow-y-auto" id="activityLog">
                    <div class="text-center py-4 text-gray-400">
                        <i class="fas fa-circle-notch fa-spin text-xl"></i>
                        <p class="mt-2">Loading activity log...</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-6 mt-12">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <h3 class="text-xl font-bold">DGST Welfare Society</h3>
                        <p class="text-gray-400 text-sm">Cloud System v4.0 | Firebase Realtime Database</p>
                        <p class="text-gray-400 text-xs mt-1" id="footerRoleInfo">
                            Logged in as: <span id="footerRole">--</span> | 
                            <span id="userCount">Users: 0</span>
                        </p>
                    </div>
                    <div class="text-center md:text-right">
                        <p class="text-gray-400 text-sm">
                            <i class="fas fa-cloud mr-1"></i> 
                            Firebase Hosting | Real-time Sync
                        </p>
                        <p class="text-gray-400 text-sm mt-1">
                            <i class="fas fa-database mr-1"></i> 
                            Cloud Backup | Multi-Device Access
                        </p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal Container -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden fade-in">
            <div class="p-6 border-b flex justify-between items-center bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                <h3 class="text-xl font-bold" id="modalTitle">Modal Title</h3>
                <button onclick="closeModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]" id="modalContent">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-xl shadow-lg z-50 max-w-md">
        <div class="flex items-center gap-3">
            <i class="fas fa-check-circle text-green-400" id="toastIcon"></i>
            <div>
                <p class="font-semibold" id="toastTitle">Success</p>
                <p class="text-sm text-gray-300" id="toastMessage">Operation completed successfully</p>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration and Main Script -->
    <script>
        // ====================
        // FIREBASE CONFIGURATION
        // ====================
        // ðŸ”¥ à¤¯à¤¹à¤¾à¤‚ à¤…à¤ªà¤¨à¤¾ Firebase configuration à¤¡à¤¾à¤²à¥‡à¤‚
        const firebaseConfig = {
            apiKey: "AIzaSyAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
            authDomain: "your-project-id.firebaseapp.com",
            databaseURL: "https://your-project-id-default-rtdb.firebaseio.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:aaaaaaaaaaaaaaaaaaaaaa"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // ====================
        // GLOBAL VARIABLES
        // ====================
        let currentUser = null;
        let currentUserRole = null;
        let currentUserEmail = null;
        let currentUserId = null;
        
        let employees = [];
        let payments = [];
        let withdrawals = [];
        let activities = [];
        let users = [];
        let settings = {};
        
        let isOnline = false;
        let lastSyncTime = null;
        let isSyncing = false;

        // ====================
        // DEFAULT EMPLOYEES DATA
        // ====================
        const DEFAULT_EMPLOYEES = [
            // ... (same as before, all 120 members)
            // Note: I'm keeping the same employee data, just shortened for brevity
            {id: 1, name: 'Ajay', designation: 'Clerk', phone: '', joinDate: '2026-01-01', retirementDate: '', 
             monthlyReceivable: 100, totalReceived: 0, currentMonthReceivable: 100, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active'},
            // ... continue with all 120 members
        ];

        // All Designations
        const ALL_DESIGNATIONS = [
            'Assistant', 'Clerk', 'Peon', 'Driver', 'Accountant', 'Junior Auditor', 
            'Steno Typist', 'DEO', 'DECO', 'Superintendent', 'Deputy Superintendent', 
            'Helper', 'PA', 'Steno Typsi', 'SSS', 'JSS', 'DTC', 'DECO', 'Other'
        ];

        // ====================
        // FIREBASE FUNCTIONS
        // ====================
        function initializeSystem() {
            showLoading("Initializing Firebase...");
            
            // Check if Firebase is initialized
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            // Check connection status
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", function(snap) {
                isOnline = snap.val() === true;
                updateConnectionStatus();
            });
            
            // Try to restore session from localStorage
            const savedUser = localStorage.getItem('dgst_current_user');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    currentUser = userData;
                    currentUserId = userData.uid;
                    currentUserEmail = userData.email;
                    loadUserRole();
                } catch (e) {
                    showLoginScreen();
                }
            } else {
                showLoginScreen();
            }
        }

        function loadUserRole() {
            showLoading("Loading user permissions...");
            
            // Check if user exists in database
            database.ref('users/' + currentUserId).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        currentUserRole = userData.role || 'viewer';
                        currentUserEmail = userData.email || currentUserEmail;
                        
                        // Update UI
                        updateUserInterface();
                        loadAllData();
                    } else {
                        // First time user - setup as admin
                        setupFirstUser();
                    }
                })
                .catch(error => {
                    console.error("Error loading user:", error);
                    showLoginScreen();
                });
        }

        function setupFirstUser() {
            // Check if there are any users in the system
            database.ref('users').once('value')
                .then(snapshot => {
                    if (!snapshot.exists() || Object.keys(snapshot.val()).length === 0) {
                        // First user becomes admin
                        currentUserRole = 'admin';
                        saveUserToDatabase();
                        initializeDefaultData();
                    } else {
                        // User doesn't exist in database, show error
                        auth.signOut();
                        showToast('Access Denied', 'User not authorized', 'error');
                        showLoginScreen();
                    }
                });
        }

        function saveUserToDatabase() {
            const userData = {
                uid: currentUserId,
                email: currentUserEmail,
                role: currentUserRole,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                lastLogin: firebase.database.ServerValue.TIMESTAMP
            };
            
            return database.ref('users/' + currentUserId).set(userData);
        }

        // ====================
        // DATA SYNC FUNCTIONS
        // ====================
        function loadAllData() {
            showLoading("Loading cloud data...");
            
            // Load all data in parallel
            Promise.all([
                loadEmployees(),
                loadPayments(),
                loadWithdrawals(),
                loadActivities(),
                loadUsers(),
                loadSettings()
            ])
            .then(() => {
                hideLoading();
                showApp();
                setupRealtimeListeners();
                updateDashboard();
                showToast('Success', 'Cloud data loaded successfully', 'success');
            })
            .catch(error => {
                console.error("Error loading data:", error);
                hideLoading();
                showToast('Error', 'Failed to load data from cloud', 'error');
            });
        }

        function loadEmployees() {
            return database.ref('employees').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        employees = [];
                        const data = snapshot.val();
                        Object.keys(data).forEach(key => {
                            employees.push({ id: key, ...data[key] });
                        });
                    } else {
                        // No employees in database, initialize with default
                        return initializeDefaultData();
                    }
                });
        }

        function loadPayments() {
            return database.ref('payments').once('value')
                .then(snapshot => {
                    payments = [];
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        Object.keys(data).forEach(key => {
                            payments.push({ id: key, ...data[key] });
                        });
                        // Sort by timestamp descending
                        payments.sort((a, b) => b.timestamp - a.timestamp);
                    }
                });
        }

        function loadWithdrawals() {
            return database.ref('withdrawals').once('value')
                .then(snapshot => {
                    withdrawals = [];
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        Object.keys(data).forEach(key => {
                            withdrawals.push({ id: key, ...data[key] });
                        });
                        withdrawals.sort((a, b) => b.timestamp - a.timestamp);
                    }
                });
        }

        function loadActivities() {
            return database.ref('activities').orderByChild('timestamp').limitToLast(50).once('value')
                .then(snapshot => {
                    activities = [];
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        Object.keys(data).forEach(key => {
                            activities.push({ id: key, ...data[key] });
                        });
                        activities.sort((a, b) => b.timestamp - a.timestamp);
                        updateActivityLog();
                    }
                });
        }

        function loadUsers() {
            return database.ref('users').once('value')
                .then(snapshot => {
                    users = [];
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        Object.keys(data).forEach(key => {
                            users.push({ id: key, ...data[key] });
                        });
                        document.getElementById('userCount').textContent = `Users: ${users.length}`;
                    }
                });
        }

        function loadSettings() {
            return database.ref('settings').once('value')
                .then(snapshot => {
                    settings = {};
                    if (snapshot.exists()) {
                        settings = snapshot.val();
                    }
                });
        }

        function setupRealtimeListeners() {
            // Real-time listeners for updates
            database.ref('employees').on('value', snapshot => {
                if (snapshot.exists()) {
                    employees = [];
                    const data = snapshot.val();
                    Object.keys(data).forEach(key => {
                        employees.push({ id: key, ...data[key] });
                    });
                    updateDashboard();
                }
            });

            database.ref('payments').orderByChild('timestamp').limitToLast(10).on('value', snapshot => {
                if (snapshot.exists()) {
                    const recent = [];
                    const data = snapshot.val();
                    Object.keys(data).forEach(key => {
                        recent.push({ id: key, ...data[key] });
                    });
                    recent.sort((a, b) => b.timestamp - a.timestamp);
                    updateRecentPayments(recent.slice(0, 10));
                }
            });

            database.ref('activities').orderByChild('timestamp').limitToLast(5).on('value', snapshot => {
                if (snapshot.exists()) {
                    const recentActs = [];
                    const data = snapshot.val();
                    Object.keys(data).forEach(key => {
                        recentActs.push({ id: key, ...data[key] });
                    });
                    recentActs.sort((a, b) => b.timestamp - a.timestamp);
                    updateActivityLog(recentActs);
                }
            });
        }

        // ====================
        // DATA SAVE FUNCTIONS
        // ====================
        function saveEmployee(employee) {
            const id = employee.id || generateId();
            const employeeRef = database.ref('employees/' + id);
            
            return employeeRef.set(employee)
                .then(() => {
                    addActivity(`Updated member: ${employee.name}`);
                    return id;
                })
                .catch(error => {
                    console.error("Error saving employee:", error);
                    throw error;
                });
        }

        function savePayment(payment) {
            const id = payment.id || generateId();
            const paymentRef = database.ref('payments/' + id);
            
            return paymentRef.set(payment)
                .then(() => {
                    addActivity(`Recorded payment of â‚¹${payment.amount} for ${payment.employeeName}`);
                    return id;
                });
        }

        function saveWithdrawal(withdrawal) {
            const id = withdrawal.id || generateId();
            const withdrawalRef = database.ref('withdrawals/' + id);
            
            return withdrawalRef.set(withdrawal)
                .then(() => {
                    addActivity(`Recorded withdrawal of â‚¹${withdrawal.amount} for ${withdrawal.purpose}`);
                    return id;
                });
        }

        function addActivity(action) {
            const activity = {
                action: action,
                user: currentUserEmail,
                userId: currentUserId,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                role: currentUserRole
            };
            
            const id = generateId();
            return database.ref('activities/' + id).set(activity);
        }

        function initializeDefaultData() {
            showLoading("Initializing default data...");
            
            const promises = [];
            
            // Save default employees
            DEFAULT_EMPLOYEES.forEach(emp => {
                const employeeData = {
                    ...emp,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                };
                promises.push(saveEmployee(employeeData));
            });
            
            // Save settings
            const defaultSettings = {
                monthlyContribution: 100,
                version: '4.0',
                initializedAt: firebase.database.ServerValue.TIMESTAMP,
                adminEmail: currentUserEmail
            };
            
            promises.push(database.ref('settings').set(defaultSettings));
            
            // Add initial activity
            promises.push(addActivity('System initialized with default data'));
            
            return Promise.all(promises)
                .then(() => {
                    showToast('Success', 'Default data initialized', 'success');
                });
        }

        // ====================
        // AUTHENTICATION FUNCTIONS
        // ====================
        function loginWithEmailPassword(email, password) {
            showLoading("Signing in...");
            
            return auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    
                    // Save user data
                    currentUser = user;
                    currentUserId = user.uid;
                    currentUserEmail = user.email;
                    
                    // Save to localStorage for session persistence
                    localStorage.setItem('dgst_current_user', JSON.stringify({
                        uid: user.uid,
                        email: user.email,
                        lastLogin: new Date().toISOString()
                    }));
                    
                    // Load user role from database
                    return loadUserRole();
                })
                .catch(error => {
                    hideLoading();
                    let errorMessage = "Login failed";
                    
                    switch(error.code) {
                        case 'auth/user-not-found':
                            errorMessage = "User not found";
                            break;
                        case 'auth/wrong-password':
                            errorMessage = "Incorrect password";
                            break;
                        case 'auth/invalid-email':
                            errorMessage = "Invalid email address";
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = "Too many attempts. Try again later";
                            break;
                    }
                    
                    showLoginError(errorMessage);
                    throw error;
                });
        }

        function createFirstAdmin(email, password) {
            showLoading("Creating admin account...");
            
            return auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    
                    currentUser = user;
                    currentUserId = user.uid;
                    currentUserEmail = user.email;
                    currentUserRole = 'admin';
                    
                    // Save user to database
                    return saveUserToDatabase();
                })
                .then(() => {
                    // Initialize default data
                    return initializeDefaultData();
                })
                .then(() => {
                    // Save to localStorage
                    localStorage.setItem('dgst_current_user', JSON.stringify({
                        uid: currentUserId,
                        email: currentUserEmail,
                        lastLogin: new Date().toISOString()
                    }));
                    
                    hideLoading();
                    showApp();
                    showToast('Success', 'Admin account created successfully', 'success');
                })
                .catch(error => {
                    hideLoading();
                    let errorMessage = "Account creation failed";
                    
                    switch(error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = "Email already in use";
                            break;
                        case 'auth/invalid-email':
                            errorMessage = "Invalid email address";
                            break;
                        case 'auth/weak-password':
                            errorMessage = "Password should be at least 6 characters";
                            break;
                    }
                    
                    showSetupError(errorMessage);
                    throw error;
                });
        }

        function changeUserPassword(newPassword) {
            showLoading("Changing password...");
            
            return currentUser.updatePassword(newPassword)
                .then(() => {
                    hideLoading();
                    showToast('Success', 'Password changed successfully', 'success');
                    return true;
                })
                .catch(error => {
                    hideLoading();
                    
                    if (error.code === 'auth/requires-recent-login') {
                        showToast('Error', 'Please re-login to change password', 'error');
                        logout();
                    } else {
                        showToast('Error', 'Failed to change password', 'error');
                    }
                    
                    return false;
                });
        }

        function logout() {
            showLoading("Logging out...");
            
            // Sign out from Firebase
            auth.signOut()
                .then(() => {
                    // Clear local data
                    currentUser = null;
                    currentUserRole = null;
                    currentUserEmail = null;
                    currentUserId = null;
                    
                    localStorage.removeItem('dgst_current_user');
                    
                    hideLoading();
                    showLoginScreen();
                    showToast('Logged Out', 'You have been logged out', 'info');
                })
                .catch(error => {
                    console.error("Logout error:", error);
                    hideLoading();
                    showLoginScreen();
                });
        }

        // ====================
        // UI HELPER FUNCTIONS
        // ====================
        function showLoading(message = "Loading...") {
            document.getElementById('loadingScreen').classList.remove('hidden');
            document.getElementById('loadingMessage').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showLoginScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }

        function showLoginError(message) {
            document.getElementById('loginError').classList.remove('hidden');
            document.getElementById('errorText').textContent = message;
        }

        function showSetupError(message) {
            document.getElementById('setupError').classList.remove('hidden');
            document.getElementById('setupErrorText').textContent = message;
        }

        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            const onlineStatus = document.getElementById('onlineStatus');
            
            if (isOnline) {
                statusElement.textContent = "Connected âœ“";
                statusElement.className = "text-green-500";
                onlineStatus.className = "online-status online";
            } else {
                statusElement.textContent = "Offline (Using local cache)";
                statusElement.className = "text-yellow-500";
                onlineStatus.className = "online-status offline";
            }
        }

        function updateUserInterface() {
            const roleBadge = document.getElementById('userRoleBadge');
            const userRoleText = document.getElementById('userRoleText');
            const dropdownUserName = document.getElementById('dropdownUserName');
            const dropdownUserRole = document.getElementById('dropdownUserRole');
            const footerRole = document.getElementById('footerRole');
            const userEmail = document.getElementById('userEmail');
            
            userEmail.textContent = currentUserEmail || '';
            
            if (currentUserRole === 'admin') {
                roleBadge.textContent = 'Admin';
                roleBadge.className = 'px-2 py-1 rounded text-xs bg-red-500 text-white';
                userRoleText.textContent = 'Admin';
                dropdownUserName.textContent = currentUserEmail || 'Admin User';
                dropdownUserRole.textContent = 'Full Access (Administrator)';
                footerRole.textContent = 'Administrator';
                
                // Show admin-only elements
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.classList.remove('hidden');
                });
                
            } else if (currentUserRole === 'viewer') {
                roleBadge.textContent = 'Viewer';
                roleBadge.className = 'px-2 py-1 rounded text-xs bg-green-500 text-white';
                userRoleText.textContent = 'Viewer';
                dropdownUserName.textContent = currentUserEmail || 'Viewer User';
                dropdownUserRole.textContent = 'Read Only Access';
                footerRole.textContent = 'Viewer';
                
                // Hide admin-only elements
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.classList.add('hidden');
                });
            }
            
            // Update last sync time
            lastSyncTime = new Date();
            document.getElementById('lastSyncTime').textContent = 
                `Last sync: ${lastSyncTime.toLocaleTimeString()}`;
        }

        // ====================
        // DASHBOARD FUNCTIONS
        // ====================
        function updateDashboard() {
            const currentMonthYear = getCurrentMonthYear();
            document.getElementById('currentMonthYear').textContent = currentMonthYear;
            
            const activeEmployees = employees.filter(emp => !emp.deleted && !emp.parked);
            const totalMembers = employees.filter(emp => !emp.deleted).length;
            const currentMonthReceivable = activeEmployees.length * 100;
            const currentMonthReceived = payments
                .filter(p => p.monthYear === currentMonthYear)
                .reduce((sum, p) => sum + p.amount, 0);
            const currentMonthWithdrawn = withdrawals
                .filter(w => w.monthYear === currentMonthYear)
                .reduce((sum, w) => sum + w.amount, 0);
            const currentBalance = calculateCurrentBalance();
            
            // Update stats
            document.getElementById('totalMembers').textContent = totalMembers;
            document.getElementById('totalReceivable').textContent = formatCurrency(currentMonthReceivable);
            document.getElementById('currentMonthReceivable').textContent = formatCurrency(currentMonthReceivable);
            document.getElementById('currentMonthReceived').textContent = formatCurrency(currentMonthReceived);
            document.getElementById('currentMonthWithdrawn').textContent = formatCurrency(currentMonthWithdrawn);
            document.getElementById('currentBalance').textContent = formatCurrency(currentBalance);
            
            const pendingCount = activeEmployees.filter(emp => {
                const employeePayments = payments.filter(p => p.employeeId === emp.id && p.monthYear === currentMonthYear);
                return employeePayments.length === 0;
            }).length;
            
            document.getElementById('pendingMembers').textContent = pendingCount;
            document.getElementById('totalReceived').textContent = formatCurrency(currentMonthReceived);
            
            const collectionPercentage = currentMonthReceivable > 0 ? (currentMonthReceived / currentMonthReceivable * 100) : 0;
            document.getElementById('collectionProgress').style.width = `${collectionPercentage}%`;
            
            updateRecentPayments();
            updateRecentWithdrawals();
        }

        function updateRecentPayments(recentData = null) {
            const recentPaymentsContainer = document.getElementById('recentPayments');
            const data = recentData || payments.slice(0, 10);
            
            if (data.length === 0) {
                recentPaymentsContainer.innerHTML = `
                    <div class="text-center py-4 text-gray-400">
                        <i class="fas fa-inbox text-2xl"></i>
                        <p class="mt-2">No recent payments</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            data.forEach(payment => {
                const member = employees.find(emp => emp.id === payment.employeeId);
                html += `
                    <div class="border border-green-200 rounded-lg p-4 hover:bg-green-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-gray-800">${member ? member.name : payment.employeeName}</p>
                                <p class="text-sm text-gray-600">${member ? member.designation : '-'}</p>
                                <p class="text-xs text-gray-500 mt-1">${formatDate(payment.date)}</p>
                            </div>
                            <div class="text-right">
                                <span class="font-bold text-green-700">${formatCurrency(payment.amount)}</span>
                                <p class="text-xs text-gray-600 mt-1">${payment.monthYear}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            recentPaymentsContainer.innerHTML = html;
        }

        function updateRecentWithdrawals() {
            const recentWithdrawalsContainer = document.getElementById('recentWithdrawals');
            const data = withdrawals.slice(0, 5);
            
            if (data.length === 0) {
                recentWithdrawalsContainer.innerHTML = `
                    <div class="text-center py-4 text-gray-400">
                        <i class="fas fa-inbox text-2xl"></i>
                        <p class="mt-2">No recent withdrawals</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            data.forEach(withdrawal => {
                html += `
                    <div class="border border-red-200 rounded-lg p-4 hover:bg-red-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-gray-800">${withdrawal.purpose}</p>
                                <p class="text-sm text-gray-600">${withdrawal.category}</p>
                                <p class="text-xs text-gray-500 mt-1">${formatDate(withdrawal.date)}</p>
                            </div>
                            <div class="text-right">
                                <span class="font-bold text-red-700">${formatCurrency(withdrawal.amount)}</span>
                                <p class="text-xs text-gray-600 mt-1">${withdrawal.monthYear}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            recentWithdrawalsContainer.innerHTML = html;
        }

        function updateActivityLog(recentData = null) {
            const activityLogContainer = document.getElementById('activityLog');
            const data = recentData || activities.slice(0, 5);
            
            if (data.length === 0) {
                activityLogContainer.innerHTML = `
                    <div class="text-center py-4 text-gray-400">
                        <i class="fas fa-history text-2xl"></i>
                        <p class="mt-2">No activity yet</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            data.forEach(activity => {
                const time = activity.timestamp ? new Date(activity.timestamp).toLocaleTimeString() : 'Just now';
                html += `
                    <div class="border border-blue-200 rounded-lg p-4 hover:bg-blue-50">
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-blue-600 text-sm"></i>
                            </div>
                            <div class="flex-grow">
                                <p class="text-sm text-gray-800">${activity.action}</p>
                                <div class="flex justify-between mt-1">
                                    <p class="text-xs text-gray-500">${activity.user || 'System'}</p>
                                    <p class="text-xs text-gray-500">${time}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            activityLogContainer.innerHTML = html;
        }

        // ====================
        // UTILITY FUNCTIONS
        // ====================
        function getCurrentMonthYear() {
            const now = new Date();
            const monthNames = ["January", "February", "March", "April", "May", "June", 
                              "July", "August", "September", "October", "November", "December"];
            return `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
        }

        function formatCurrency(amount) {
            return 'â‚¹' + amount.toLocaleString('en-IN');
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function calculateCurrentBalance() {
            const totalReceived = payments.reduce((sum, p) => sum + p.amount, 0);
            const totalWithdrawn = withdrawals.reduce((sum, w) => sum + w.amount, 0);
            return totalReceived - totalWithdrawn;
        }

        function showToast(title, message, type = 'success') {
            const iconMap = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const colorMap = {
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400',
                info: 'text-blue-400'
            };
            
            document.getElementById('toastIcon').className = `fas ${iconMap[type]} ${colorMap[type]}`;
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = message;
            
            const toast = document.getElementById('toast');
            toast.classList.remove('hidden');
            toast.classList.add('undo-toast');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // ====================
        // USER MANAGEMENT FUNCTIONS
        // ====================
        function showUsersManagement() {
            if (currentUserRole !== 'admin') {
                showToast('Access Denied', 'Admin access required', 'error');
                return;
            }
            
            loadUsers().then(() => {
                let html = `
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-cyan-500 to-blue-600 text-white rounded-xl p-6">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-users-cog text-3xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold">User Management</h3>
                                    <p class="opacity-90">Manage cloud users and permissions</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold text-gray-800">Registered Users (${users.length})</h4>
                            <button onclick="showAddUserModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                <i class="fas fa-user-plus mr-2"></i>Add User
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                `;
                
                if (users.length === 0) {
                    html += `<p class="text-gray-500 text-center py-4">No users found</p>`;
                } else {
                    users.forEach(user => {
                        const isCurrentUser = user.id === currentUserId;
                        html += `
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-semibold text-gray-800">${user.email}</p>
                                        <div class="flex items-center gap-3 mt-1">
                                            <span class="px-2 py-1 text-xs rounded ${user.role === 'admin' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                                ${user.role}
                                            </span>
                                            <span class="text-xs text-gray-500">
                                                Joined: ${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : '--'}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        ${!isCurrentUser ? `
                                        <button onclick="changeUserRole('${user.id}', '${user.role === 'admin' ? 'viewer' : 'admin'}')" 
                                                class="text-blue-600 hover:text-blue-800" title="Change Role">
                                            <i class="fas fa-exchange-alt"></i>
                                        </button>
                                        <button onclick="deleteUser('${user.id}')" 
                                                class="text-red-600 hover:text-red-800" title="Delete User">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        ` : `
                                        <span class="text-sm text-gray-500">Current User</span>
                                        `}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `
                        </div>
                        
                        <div class="flex gap-4">
                            <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                                <i class="fas fa-times mr-2"></i>Close
                            </button>
                        </div>
                    </div>
                `;
                
                showModal('User Management', html);
            });
        }

        function showAddUserModal() {
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-user-plus text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Add New User</h3>
                                <p class="opacity-90">Add user to cloud system</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                            <input type="email" id="newUserEmail" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="user@example.com">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                            <input type="password" id="newUserPassword" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Minimum 6 characters">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Role</label>
                            <select id="newUserRole" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                <option value="viewer">Viewer (Read Only)</option>
                                <option value="admin">Admin (Full Access)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="addUserError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                    
                    <div class="flex gap-4">
                        <button onclick="createNewUser()" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-700 text-white py-3 rounded-xl font-semibold hover:from-green-700 hover:to-emerald-800">
                            <i class="fas fa-save mr-2"></i>Create User
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Add New User', html);
        }

        function createNewUser() {
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            if (!email || !password) {
                showError('addUserError', 'Please fill all fields');
                return;
            }
            
            if (password.length < 6) {
                showError('addUserError', 'Password must be at least 6 characters');
                return;
            }
            
            showLoading("Creating user...");
            
            // Create user in Firebase Auth
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    
                    // Save user data to database
                    const userData = {
                        uid: user.uid,
                        email: user.email,
                        role: role,
                        createdBy: currentUserEmail,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    return database.ref('users/' + user.uid).set(userData);
                })
                .then(() => {
                    hideLoading();
                    closeModal();
                    showToast('Success', 'User created successfully', 'success');
                    showUsersManagement();
                    addActivity(`Created new ${role} user: ${email}`);
                })
                .catch(error => {
                    hideLoading();
                    let errorMessage = "Failed to create user";
                    
                    switch(error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = "Email already in use";
                            break;
                        case 'auth/invalid-email':
                            errorMessage = "Invalid email address";
                            break;
                        case 'auth/weak-password':
                            errorMessage = "Password is too weak";
                            break;
                    }
                    
                    showError('addUserError', errorMessage);
                });
        }

        function changeUserRole(userId, newRole) {
            if (!confirm(`Change user role to ${newRole}?`)) return;
            
            showLoading("Updating user role...");
            
            database.ref('users/' + userId).update({
                role: newRole,
                updatedAt: firebase.database.ServerValue.TIMESTAMP,
                updatedBy: currentUserEmail
            })
            .then(() => {
                hideLoading();
                showToast('Success', 'User role updated', 'success');
                showUsersManagement();
                addActivity(`Changed user role to ${newRole}`);
            })
            .catch(error => {
                hideLoading();
                showToast('Error', 'Failed to update role', 'error');
            });
        }

        function deleteUser(userId) {
            if (!confirm("Are you sure you want to delete this user? This action cannot be undone.")) return;
            
            showLoading("Deleting user...");
            
            // First remove from database
            database.ref('users/' + userId).remove()
                .then(() => {
                    hideLoading();
                    showToast('Success', 'User deleted', 'success');
                    showUsersManagement();
                    addActivity("Deleted user from system");
                })
                .catch(error => {
                    hideLoading();
                    showToast('Error', 'Failed to delete user', 'error');
                });
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove('hidden');
        }

        // ====================
        // OTHER FEATURE FUNCTIONS (Same as before, but adapted for Firebase)
        // ====================
        function showQuickPaymentModal() {
            if (currentUserRole !== 'admin') {
                showToast('Access Denied', 'Admin access required', 'error');
                return;
            }
            
            // ... (similar to previous version, but using Firebase)
            // For brevity, including just the structure
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-money-bill-wave text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Quick Payment</h3>
                                <p class="opacity-90">Record payment for current month</p>
                            </div>
                        </div>
                    </div>
                    <!-- Form content -->
                </div>
            `;
            
            showModal('Quick Payment', html);
        }

        // Similarly adapt all other functions (showAddMemberModal, showAllMembersView, etc.)
        // They will work the same way but save to Firebase instead of localStorage

        // ====================
        // INITIALIZATION
        // ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Firebase
            initializeSystem();
            
            // Event Listeners
            document.getElementById('loginBtn').addEventListener('click', function() {
                const email = document.getElementById('emailInput').value.trim();
                const password = document.getElementById('passwordInput').value;
                
                if (!email || !password) {
                    showLoginError('Please enter email and password');
                    return;
                }
                
                loginWithEmailPassword(email, password).catch(() => {
                    // Error already handled
                });
            });
            
            document.getElementById('setupFirstTimeBtn').addEventListener('click', function() {
                document.getElementById('emailLoginForm').classList.add('hidden');
                document.getElementById('firstTimeSetupForm').classList.remove('hidden');
            });
            
            document.getElementById('backToLoginBtn').addEventListener('click', function() {
                document.getElementById('firstTimeSetupForm').classList.add('hidden');
                document.getElementById('emailLoginForm').classList.remove('hidden');
                document.getElementById('setupError').classList.add('hidden');
            });
            
            document.getElementById('setupBtn').addEventListener('click', function() {
                const email = document.getElementById('setupEmail').value.trim();
                const password = document.getElementById('setupPassword').value;
                const confirmPassword = document.getElementById('setupConfirmPassword').value;
                
                if (!email || !password || !confirmPassword) {
                    showSetupError('Please fill all fields');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showSetupError('Passwords do not match');
                    return;
                }
                
                if (password.length < 6) {
                    showSetupError('Password must be at least 6 characters');
                    return;
                }
                
                createFirstAdmin(email, password);
            });
            
            document.getElementById('togglePassword').addEventListener('click', function() {
                const passwordInput = document.getElementById('passwordInput');
                const icon = this.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.className = 'fas fa-eye-slash';
                } else {
                    passwordInput.type = 'password';
                    icon.className = 'fas fa-eye';
                }
            });
            
            // User menu dropdown
            const userMenuBtn = document.getElementById('userMenuBtn');
            const userDropdown = document.getElementById('userDropdown');
            
            if (userMenuBtn && userDropdown) {
                userMenuBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userDropdown.classList.toggle('hidden');
                });
                
                document.addEventListener('click', function(e) {
                    if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }
            
            // Manage users button
            document.getElementById('manageUsersBtn')?.addEventListener('click', function() {
                showUsersManagement();
                userDropdown.classList.add('hidden');
            });
            
            // Change password button
            document.getElementById('changePasswordBtn')?.addEventListener('click', function() {
                showChangePasswordModal();
                userDropdown.classList.add('hidden');
            });
            
            // Cloud backup button
            document.getElementById('cloudBackupBtn')?.addEventListener('click', function() {
                exportDataForEmail();
                userDropdown.classList.add('hidden');
            });
            
            // Update date time
            updateDateTime();
            setInterval(updateDateTime, 60000);
        });

        function updateDateTime() {
            const now = new Date();
            const dateTimeStr = now.toLocaleDateString('en-IN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) + ' | ' + now.toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            
            document.getElementById('currentDateTime').textContent = dateTimeStr;
        }

        // ====================
        // GLOBAL FUNCTION EXPORTS
        // ====================
        window.logout = logout;
        window.closeModal = closeModal;
        window.showQuickPaymentModal = showQuickPaymentModal;
        window.showAddMemberModal = showAddMemberModal;
        window.showAllMembersView = showAllMembersView;
        window.showMonthlyReport = showMonthlyReport;
        window.showMessagingPanel = showMessagingPanel;
        window.showAllMembersEdit = showAllMembersEdit;
        window.showPaymentReports = showPaymentReports;
        window.showPendingPayments = showPendingPayments;
        window.showExcelExportOptions = showExcelExportOptions;
        window.showParkedMembers = showParkedMembers;
        window.exportDataForEmail = exportDataForEmail;
        window.showWithdrawalReports = showWithdrawalReports;
        window.showRetiredMembersDetails = showRetiredMembersDetails;
        window.showMainAccountWithdrawalModal = showMainAccountWithdrawalModal;
        window.showUsersManagement = showUsersManagement;

        // Export functions (same as before but adapted for Firebase)
        function exportDataForEmail() {
            const data = {
                employees: employees.filter(emp => !emp.deleted),
                payments: payments,
                withdrawals: withdrawals,
                activities: activities,
                users: users,
                summary: {
                    totalMembers: employees.filter(emp => !emp.deleted).length,
                    currentBalance: calculateCurrentBalance(),
                    lastUpdated: new Date().toISOString(),
                    exportedBy: currentUserEmail
                }
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `DGST_Cloud_Backup_${new Date().toISOString().split('T')[0]}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Backup Created', 'JSON backup downloaded', 'success');
            addActivity('Exported cloud backup');
        }

        function showChangePasswordModal() {
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-key text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Change Password</h3>
                                <p class="opacity-90">Update your account password</p>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Current Password</label>
                            <input type="password" id="currentPassword" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">New Password</label>
                            <input type="password" id="newPassword" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Confirm New Password</label>
                            <input type="password" id="confirmNewPassword" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                        </div>
                    </div>

                    <div id="passwordError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>

                    <div class="flex gap-4">
                        <button onclick="updatePassword()" class="flex-1 bg-gradient-to-r from-blue-600 to-purple-700 text-white py-3 rounded-xl font-semibold hover:from-blue-700 hover:to-purple-800">
                            <i class="fas fa-save mr-2"></i>Update Password
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Change Password', html);
        }

        function updatePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            
            if (!newPassword || !confirmPassword) {
                showError('passwordError', 'Please fill all fields');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showError('passwordError', 'Passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                showError('passwordError', 'Password must be at least 6 characters');
                return;
            }
            
            changeUserPassword(newPassword).then(success => {
                if (success) {
                    closeModal();
                }
            });
        }

    </script>
</body>
</html>